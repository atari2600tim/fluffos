name: CI on Windows

on:
  push:
    branches:
      - *
    paths-ignore:
      - 'docs/**'
  pull_request:
    branches:
      - *
    paths-ignore:
      - 'docs/**'
jobs:
  build:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        arch: [64]
        build: ["Debug", "RelWithDebInfo"]

    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          update: true
      - uses: actions/checkout@v2
      - name: Install
        run: |
          if [ "$MSYSTEM" = "MINGW32" ]; then
            echo "TODO"
          else
            pacman --noconfirm -S --needed mingw-w64-x86_64-toolchain mingw-w64-x86_64-cmake mingw-w64-x86_64-zlib mingw-w64-x86_64-libevent mingw-w64-x86_64-pcre mingw-w64-x86_64-icu mingw-w64-x86_64-sqlite3
          fi
          pacman --noconfirm -S --needed bison make
      - name: Build
        run: |
          mkdir build && cd build && cmake -G "MSYS Makefiles" -DCMAKE_BUILD_TYPE=${{ matrix.build }} -DMARCH_NATIVE=OFF -DPACKAGE_CRYPTO=OFF -DPACKAGE_DB_MYSQL="" -DPACKAGE_DB_SQLITE=1 .. && make -j 2 install
      - name: Testsuite
        run: |
          cd testsuite && ../build/bin/driver etc/config.test -ftest
      - name: 'Prepare Lil Artifact'
        run: |
          mkdir lil
          mkdir lil/src
          cp build/bin/driver.exe lil
          cp -r build/bin/www lil/src
          cp -r testsuite lil
          echo @echo off >> lil/startlil.bat
          echo echo Game will be on port 4000, web client on http://localhost:4001 >> lil/startlil.bat
          echo pause >> lil/startlil.bat
          echo cd testsuite >> lil/startlil.bat
          echo ..\\driver etc\\config.test >> lil/startlil.bat
          echo echo Game has finished >> lil/startlil.bat
          echo pause >> lil/startlil.bat
      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v2
        with:
          name: lil
          path: lil/
